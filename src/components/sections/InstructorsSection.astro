---
interface Props {
  title?: string;
  description?: string;
  limit?: number;
  columns?: 2 | 3 | 4;
  variant?: 'light' | 'gray' | 'dark' | 'darker';
}

const {
  title = 'Meet Our Instructors',
  description = 'Our experienced team of flight instructors are here to help you achieve your aviation goals.',
  limit,
  columns = 3,
  variant = 'light'
} = Astro.props;

const gridCols = {
  2: 'md:grid-cols-2',
  3: 'md:grid-cols-2 lg:grid-cols-3',
  4: 'md:grid-cols-2 lg:grid-cols-4'
};

const bgClasses = {
  light: 'bg-white',
  gray: 'bg-gray-50',
  dark: 'bg-[#444444] text-white',
  darker: 'bg-[#222222] text-white'
};

const textClasses = {
  light: { title: 'text-gray-900', description: 'text-gray-600', loading: 'text-gray-500' },
  gray: { title: 'text-gray-900', description: 'text-gray-600', loading: 'text-gray-500' },
  dark: { title: 'text-white', description: 'text-gray-300', loading: 'text-gray-400' },
  darker: { title: 'text-white', description: 'text-gray-300', loading: 'text-gray-400' }
};
---

<section class={`py-16 ${bgClasses[variant]}`} id="instructors" data-variant={variant}>
  <div class="container mx-auto px-4">
    <div class="text-center mb-12">
      <h2 class={`text-3xl md:text-4xl font-bold mb-4 ${textClasses[variant].title}`}>{title}</h2>
      <p class={`text-lg max-w-2xl mx-auto ${textClasses[variant].description}`}>{description}</p>
    </div>

    <!-- Loading State -->
    <div id="instructors-loading" class="text-center py-12">
      <div class={`inline-block w-8 h-8 border-4 border-t-transparent rounded-full animate-spin ${variant === 'dark' || variant === 'darker' ? 'border-white' : 'border-blue-600'}`}></div>
      <p class={`mt-4 ${textClasses[variant].loading}`}>Loading instructors...</p>
    </div>

    <!-- Instructors Grid (hidden until loaded) -->
    <div id="instructors-grid" class={`hidden grid gap-6 ${gridCols[columns]}`} data-limit={limit || ''}>
    </div>

    <!-- Error State -->
    <div id="instructors-error" class="hidden text-center text-gray-500">
      <p>Instructor information is being updated. Please check back soon.</p>
    </div>
  </div>
</section>

<script>
  const CONTENTFUL_BASE = 'https://cdn.contentful.com/spaces/gf6i9onr9mz0/environments/master';
  const ACCESS_TOKEN = 'hx8ZbAb984moIf6MxQ_3ZmqvbtEiENQt5tqh_E846EM';

  async function loadInstructors() {
    const loadingEl = document.getElementById('instructors-loading');
    const gridEl = document.getElementById('instructors-grid');
    const errorEl = document.getElementById('instructors-error');
    const limit = gridEl?.dataset.limit ? parseInt(gridEl.dataset.limit) : null;

    try {
      const url = `${CONTENTFUL_BASE}/entries?access_token=${ACCESS_TOKEN}&content_type=instructor&order=fields.order`;
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to fetch');

      const data = await response.json();
      const assets = data.includes?.Asset || [];

      const getAssetUrl = (assetRef: { sys: { id: string } } | undefined) => {
        if (!assetRef) return null;
        const asset = assets.find((a: { sys: { id: string } }) => a.sys.id === assetRef.sys.id);
        return asset ? `https:${asset.fields.file.url}` : null;
      };

      let instructors = data.items.map((item: any) => ({
        name: item.fields.name || 'Unknown',
        availability: item.fields.availability,
        description: item.fields.description || '',
        image: getAssetUrl(item.fields.image) || '',
        image2: getAssetUrl(item.fields.image2),
      }));

      if (limit) {
        instructors = instructors.slice(0, limit);
      }

      if (instructors.length === 0) {
        loadingEl?.classList.add('hidden');
        errorEl?.classList.remove('hidden');
        return;
      }

      // Render instructors
      if (gridEl) {
        gridEl.innerHTML = instructors.map((instructor: any) => `
          <div class="bg-white rounded-xl shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300">
            <div class="relative h-64 overflow-hidden bg-gray-100 ${instructor.image2 ? 'cursor-pointer instructor-image-toggle' : ''}">
              ${instructor.image ? `
                <img
                  src="${instructor.image}"
                  alt="${instructor.name}"
                  class="instructor-img-primary w-full h-full object-cover object-center transition-all duration-500 group-hover:scale-105"
                  loading="lazy"
                />
                ${instructor.image2 ? `
                  <img
                    src="${instructor.image2}"
                    alt="${instructor.name} - alternate"
                    class="instructor-img-alt absolute inset-0 w-full h-full object-cover object-center opacity-0 group-hover:opacity-100 transition-all duration-500"
                    loading="lazy"
                  />
                ` : ''}
              ` : `
                <div class="w-full h-full flex items-center justify-center">
                  <svg class="w-24 h-24 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                </div>
              `}
            </div>
            <div class="p-6">
              <h3 class="text-xl font-bold text-gray-900 mb-1">${instructor.name}</h3>
              ${instructor.availability ? `
                <p class="text-sm font-medium text-blue-600 mb-3">${instructor.availability}</p>
              ` : ''}
              <p class="text-gray-600 text-sm leading-relaxed">${instructor.description}</p>
            </div>
          </div>
        `).join('');

        // Add click handlers for image toggle on mobile
        gridEl.querySelectorAll('.instructor-image-toggle').forEach((container) => {
          container.addEventListener('click', () => {
            container.classList.toggle('showing-alt');
          });
        });
      }

      loadingEl?.classList.add('hidden');
      gridEl?.classList.remove('hidden');
    } catch (error) {
      console.error('Failed to load instructors:', error);
      loadingEl?.classList.add('hidden');
      errorEl?.classList.remove('hidden');
    }
  }

  loadInstructors();
</script>

<style>
  /* Toggle alternate image on click (for mobile) */
  .instructor-image-toggle.showing-alt .instructor-img-primary {
    opacity: 0;
  }
  .instructor-image-toggle.showing-alt .instructor-img-alt {
    opacity: 1;
  }
</style>
