---
interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'Our Fleet',
  description = 'We maintain a diverse fleet of well-equipped aircraft for all your training needs.'
} = Astro.props;
---

<section class="py-16 bg-gray-50" id="fleet">
  <div class="container mx-auto px-4">
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">{title}</h2>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">{description}</p>
    </div>

    <!-- Loading State -->
    <div id="fleet-loading" class="text-center py-12">
      <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-gray-500 mt-4">Loading fleet...</p>
    </div>

    <!-- Fleet Grid (hidden until loaded) -->
    <div id="fleet-grid" class="hidden grid gap-8 md:grid-cols-2 lg:grid-cols-3">
    </div>

    <!-- Error State -->
    <div id="fleet-error" class="hidden text-center text-gray-500">
      <p>Fleet information is being updated. Please check back soon.</p>
    </div>
  </div>
</section>

<script>
  const CONTENTFUL_BASE = 'https://cdn.contentful.com/spaces/gf6i9onr9mz0/environments/master';
  const ACCESS_TOKEN = 'hx8ZbAb984moIf6MxQ_3ZmqvbtEiENQt5tqh_E846EM';

  // Convert rich text to HTML
  function richTextToHtml(richText: any): string {
    if (!richText?.content) return '';

    return richText.content
      .map((node: any) => {
        if (node.nodeType === 'paragraph' && node.content) {
          const innerHtml = node.content
            .map((item: any) => {
              if (item.nodeType === 'text') {
                let text = item.value || '';
                if (item.marks) {
                  for (const mark of item.marks) {
                    if (mark.type === 'bold') {
                      text = `<strong>${text}</strong>`;
                    } else if (mark.type === 'italic') {
                      text = `<em>${text}</em>`;
                    }
                  }
                }
                return text;
              }
              if (item.nodeType === 'hyperlink' && item.content?.[0] && item.data?.uri) {
                const linkText = item.content[0].value || '';
                return `<a href="${item.data.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${linkText}</a>`;
              }
              return '';
            })
            .join('');
          return `<p>${innerHtml}</p>`;
        }
        return '';
      })
      .join('');
  }

  async function loadFleet() {
    const loadingEl = document.getElementById('fleet-loading');
    const gridEl = document.getElementById('fleet-grid');
    const errorEl = document.getElementById('fleet-error');

    try {
      const url = `${CONTENTFUL_BASE}/entries?access_token=${ACCESS_TOKEN}&content_type=aircraft&order=fields.order`;
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to fetch');

      const data = await response.json();
      const assets = data.includes?.Asset || [];

      const getAssetUrl = (assetRef: { sys: { id: string } } | undefined) => {
        if (!assetRef) return null;
        const asset = assets.find((a: { sys: { id: string } }) => a.sys.id === assetRef.sys.id);
        return asset ? `https:${asset.fields.file.url}` : null;
      };

      const fleet = data.items.map((item: any) => ({
        title: item.fields.title || 'Unknown Aircraft',
        descriptionHtml: richTextToHtml(item.fields.description),
        image: getAssetUrl(item.fields.image) || '',
        image2: getAssetUrl(item.fields.image2),
        pricing: item.fields.pricing,
      }));

      if (fleet.length === 0) {
        loadingEl?.classList.add('hidden');
        errorEl?.classList.remove('hidden');
        return;
      }

      // Render fleet
      if (gridEl) {
        gridEl.innerHTML = fleet.map((aircraft: any) => `
          <div class="bg-white rounded-xl shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300">
            <div class="relative h-56 overflow-hidden">
              ${aircraft.image ? `
                <img
                  src="${aircraft.image}"
                  alt="${aircraft.title}"
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  loading="lazy"
                />
                ${aircraft.image2 ? `
                  <img
                    src="${aircraft.image2}"
                    alt="${aircraft.title} - alternate view"
                    class="absolute inset-0 w-full h-full object-cover opacity-0 group-hover:opacity-100 transition-opacity duration-500"
                    loading="lazy"
                  />
                ` : ''}
              ` : ''}
            </div>
            <div class="p-6">
              <h3 class="text-xl font-bold text-gray-900 mb-3">${aircraft.title}</h3>
              <div class="text-gray-600 mb-4 prose prose-sm max-w-none">
                ${aircraft.descriptionHtml}
              </div>
              ${aircraft.pricing ? `
                <div class="pt-4 border-t border-gray-100">
                  <span class="text-sm text-gray-500">Pricing:</span>
                  <span class="ml-2 font-semibold text-blue-600">${aircraft.pricing}</span>
                </div>
              ` : ''}
            </div>
          </div>
        `).join('');
      }

      loadingEl?.classList.add('hidden');
      gridEl?.classList.remove('hidden');
    } catch (error) {
      console.error('Failed to load fleet:', error);
      loadingEl?.classList.add('hidden');
      errorEl?.classList.remove('hidden');
    }
  }

  loadFleet();
</script>
