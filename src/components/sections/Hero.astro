---
import { getCollection } from 'astro:content';

interface Props {
  /** Use static slides instead of content collection */
  slides?: {
    slogan: string;
    subtitle: string;
    buttonText: string;
    buttonAction: string;
    image?: string;
  }[];
  /** Show single slide instead of carousel */
  single?: boolean;
}

const { slides: propSlides, single = false } = Astro.props;

// Get slides from content collection or props
let slides = propSlides;
if (!slides) {
  const heroSlides = await getCollection('hero-slides');
  slides = heroSlides
    .sort((a, b) => a.data.order - b.data.order)
    .map((slide) => slide.data);
}

const displaySlides = single ? [slides[0]] : slides;
---

<section class="relative overflow-hidden">
  <!-- Slides Container -->
  <div class="hero-carousel relative" data-single={single}>
    {displaySlides.map((slide, index) => (
      <div
        class:list={[
          "hero-slide min-h-[600px] md:min-h-[700px] flex items-center justify-center relative",
          index === 0 ? "active" : "hidden"
        ]}
        data-index={index}
      >
        <!-- Background Image -->
        {slide.image && (
          <div
            class="absolute inset-0 bg-cover bg-center bg-no-repeat"
            style={`background-image: url('/images/hero/${slide.image}')`}
          >
            <div class="absolute inset-0 bg-black/50"></div>
          </div>
        )}

        <!-- Gradient fallback if no image -->
        {!slide.image && (
          <div class="absolute inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-slate-900"></div>
        )}

        <!-- Content -->
        <div class="relative z-10 container mx-auto px-4 py-16 text-center text-white">
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6 animate-fade-in">
            {slide.slogan}
          </h1>
          <p class="text-lg md:text-xl lg:text-2xl max-w-3xl mx-auto mb-8 text-gray-200 leading-relaxed">
            {slide.subtitle}
          </p>
          <a
            href={slide.buttonAction}
            class="inline-block px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1"
          >
            {slide.buttonText}
          </a>
        </div>
      </div>
    ))}
  </div>

  <!-- Navigation Dots (only show if multiple slides) -->
  {!single && slides.length > 1 && (
    <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 z-20 flex space-x-3">
      {slides.map((_, index) => (
        <button
          class:list={[
            "hero-dot w-3 h-3 rounded-full transition-all duration-300",
            index === 0 ? "bg-white scale-125" : "bg-white/50 hover:bg-white/75"
          ]}
          data-index={index}
          aria-label={`Go to slide ${index + 1}`}
        />
      ))}
    </div>
  )}

  <!-- Navigation Arrows (only show if multiple slides) -->
  {!single && slides.length > 1 && (
    <>
      <button
        class="hero-prev absolute left-4 top-1/2 -translate-y-1/2 z-20 p-3 bg-black/30 hover:bg-black/50 text-white rounded-full transition-all duration-300"
        aria-label="Previous slide"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button
        class="hero-next absolute right-4 top-1/2 -translate-y-1/2 z-20 p-3 bg-black/30 hover:bg-black/50 text-white rounded-full transition-all duration-300"
        aria-label="Next slide"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </>
  )}
</section>

<style>
  .hero-slide {
    transition: opacity 0.5s ease-in-out;
  }

  .hero-slide.hidden {
    display: none;
  }

  .hero-slide.active {
    display: flex;
  }

  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.6s ease-out;
  }
</style>

<script>
  class HeroCarousel {
    private container: HTMLElement;
    private slides: HTMLElement[];
    private dots: HTMLElement[];
    private currentIndex: number = 0;
    private interval: ReturnType<typeof setInterval> | null = null;
    private autoPlayDelay: number = 6000;

    constructor(container: HTMLElement) {
      this.container = container;
      this.slides = Array.from(container.querySelectorAll('.hero-slide'));
      this.dots = Array.from(container.parentElement?.querySelectorAll('.hero-dot') || []);

      if (this.slides.length <= 1 || container.dataset.single === 'true') return;

      this.init();
    }

    private init() {
      // Dot navigation
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', () => this.goTo(index));
      });

      // Arrow navigation
      const prevBtn = this.container.parentElement?.querySelector('.hero-prev');
      const nextBtn = this.container.parentElement?.querySelector('.hero-next');

      prevBtn?.addEventListener('click', () => this.prev());
      nextBtn?.addEventListener('click', () => this.next());

      // Auto-play
      this.startAutoPlay();

      // Pause on hover
      this.container.addEventListener('mouseenter', () => this.stopAutoPlay());
      this.container.addEventListener('mouseleave', () => this.startAutoPlay());

      // Touch/swipe support
      let touchStartX = 0;
      this.container.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
      });
      this.container.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) this.next();
          else this.prev();
        }
      });
    }

    private goTo(index: number) {
      if (index === this.currentIndex) return;

      this.slides[this.currentIndex].classList.remove('active');
      this.slides[this.currentIndex].classList.add('hidden');
      this.dots[this.currentIndex]?.classList.remove('bg-white', 'scale-125');
      this.dots[this.currentIndex]?.classList.add('bg-white/50');

      this.currentIndex = index;

      this.slides[this.currentIndex].classList.remove('hidden');
      this.slides[this.currentIndex].classList.add('active');
      this.dots[this.currentIndex]?.classList.remove('bg-white/50');
      this.dots[this.currentIndex]?.classList.add('bg-white', 'scale-125');
    }

    private next() {
      const nextIndex = (this.currentIndex + 1) % this.slides.length;
      this.goTo(nextIndex);
    }

    private prev() {
      const prevIndex = (this.currentIndex - 1 + this.slides.length) % this.slides.length;
      this.goTo(prevIndex);
    }

    private startAutoPlay() {
      this.stopAutoPlay();
      this.interval = setInterval(() => this.next(), this.autoPlayDelay);
    }

    private stopAutoPlay() {
      if (this.interval) {
        clearInterval(this.interval);
        this.interval = null;
      }
    }
  }

  // Initialize all hero carousels
  document.querySelectorAll('.hero-carousel').forEach((container) => {
    new HeroCarousel(container as HTMLElement);
  });
</script>
