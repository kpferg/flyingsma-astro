---
import FlightSchoolLayout from "../../../layouts/FlightSchoolLayout.astro";
import BreadcrumbSchema from "../../../components/seo/BreadcrumbSchema.astro";

const breadcrumbs = [
  { name: 'Home', url: 'https://www.flyingsma.com/' },
  { name: 'Flight School', url: 'https://www.flyingsma.com/flight-school/' },
  { name: 'News', url: 'https://www.flyingsma.com/flight-school/news/' },
];
---

<FlightSchoolLayout title="Flight School News" description="Stay up to date with the latest news and events from Southern Maine Aviation's Flight School.">
	<BreadcrumbSchema slot="head" items={breadcrumbs} />
	<!-- Page Header -->
	<section class="bg-gradient-to-br from-blue-900 to-blue-800 text-white py-16">
		<div class="container mx-auto px-4 text-center">
			<h1 class="text-4xl md:text-5xl font-bold mb-4">Flight School News</h1>
			<p class="text-xl text-blue-200 max-w-2xl mx-auto">
				Stay up to date with the latest happenings at our flight school
			</p>
		</div>
	</section>

	<!-- News Grid -->
	<section class="py-16 bg-gray-50">
		<div class="container mx-auto px-4">
			<!-- Loading State -->
			<div id="news-loading" class="text-center py-12">
				<div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
				<p class="text-gray-500 mt-4">Loading news...</p>
			</div>

			<!-- News Grid (hidden until loaded) -->
			<div id="news-grid" class="hidden grid gap-8 md:grid-cols-2 lg:grid-cols-3">
			</div>

			<!-- Empty State -->
			<div id="news-empty" class="hidden text-center py-12">
				<p class="text-gray-500 text-lg">No news articles found.</p>
				<a href="/flight-school" class="inline-flex items-center mt-4 text-blue-600 hover:text-blue-800">
					<i class="fa-solid fa-chevron-left mr-2"></i>
					Back to Flight School
				</a>
			</div>

			<!-- Error State -->
			<div id="news-error" class="hidden text-center py-12">
				<p class="text-gray-500 text-lg">News is temporarily unavailable. Please check back soon.</p>
				<a href="/flight-school" class="inline-flex items-center mt-4 text-blue-600 hover:text-blue-800">
					<i class="fa-solid fa-chevron-left mr-2"></i>
					Back to Flight School
				</a>
			</div>
		</div>
	</section>

	<!-- Back Link -->
	<section class="py-8 bg-white">
		<div class="container mx-auto px-4 text-center">
			<a href="/flight-school" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium">
				<i class="fa-solid fa-chevron-left mr-2"></i>
				Back to Flight School
			</a>
		</div>
	</section>
</FlightSchoolLayout>

<style>
	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>

<script>
	const CONTENTFUL_BASE = 'https://cdn.contentful.com/spaces/gf6i9onr9mz0/environments/master';
	const ACCESS_TOKEN = 'hx8ZbAb984moIf6MxQ_3ZmqvbtEiENQt5tqh_E846EM';

	// Convert rich text to plain text
	function richTextToPlainText(richText: any): string {
		if (!richText?.content) return '';

		return richText.content
			.map((node: any) => {
				if (!node.content) return '';
				return node.content
					.map((item: any) => {
						if (item.nodeType === 'text') {
							return item.value || '';
						}
						if (item.nodeType === 'hyperlink' && item.content?.[0]) {
							return item.content[0].value || '';
						}
						return '';
					})
					.join('');
			})
			.join('\n\n');
	}

	function formatDate(dateString: string): string {
		const date = new Date(dateString);
		return new Intl.DateTimeFormat('en-US', {
			year: 'numeric',
			month: 'long',
			day: 'numeric'
		}).format(date);
	}

	async function loadNews() {
		const loadingEl = document.getElementById('news-loading');
		const gridEl = document.getElementById('news-grid');
		const emptyEl = document.getElementById('news-empty');
		const errorEl = document.getElementById('news-error');

		try {
			const url = `${CONTENTFUL_BASE}/entries?access_token=${ACCESS_TOKEN}&content_type=news-events&order=-sys.updatedAt`;
			const response = await fetch(url);
			if (!response.ok) throw new Error('Failed to fetch');

			const data = await response.json();
			const assets = data.includes?.Asset || [];

			const getAssetUrl = (assetRef: { sys: { id: string } } | undefined) => {
				if (!assetRef) return null;
				const asset = assets.find((a: { sys: { id: string } }) => a.sys.id === assetRef.sys.id);
				return asset ? `https:${asset.fields.file.url}` : null;
			};

			const news = data.items.map((item: any) => ({
				headline: item.fields.headline || 'Untitled',
				description: richTextToPlainText(item.fields.description),
				image: getAssetUrl(item.fields.image),
				document: getAssetUrl(item.fields.document),
				buttonText: item.fields.buttonText,
				buttonAction: item.fields.buttonAction,
				buttonTarget: item.fields.buttonTarget,
				updatedAt: item.sys.updatedAt,
			}));

			if (news.length === 0) {
				loadingEl?.classList.add('hidden');
				emptyEl?.classList.remove('hidden');
				return;
			}

			// Render news
			if (gridEl) {
				gridEl.innerHTML = news.map((item: any) => `
					<article class="bg-white rounded-xl shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300">
						${item.image ? `
							<a href="${item.image}" target="_blank" rel="noopener noreferrer" class="block overflow-hidden bg-gray-100">
								<img
									src="${item.image}"
									alt="${item.headline}"
									class="w-full h-auto group-hover:scale-105 transition-transform duration-300"
									loading="lazy"
								/>
							</a>
						` : ''}
						<div class="p-6">
							<time class="text-sm text-gray-500" datetime="${item.updatedAt}">
								${formatDate(item.updatedAt)}
							</time>
							<h2 class="text-xl font-bold text-gray-900 mt-2 mb-3">
								${item.headline}
							</h2>
							${item.description ? `
								<p class="text-gray-600 mb-4 line-clamp-3">${item.description}</p>
							` : ''}
							<div class="flex flex-wrap gap-3">
								${item.buttonText && item.buttonAction ? `
									<a
										href="${item.buttonAction}"
										${item.buttonTarget === '_blank' ? 'target="_blank" rel="noopener noreferrer"' : ''}
										class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium"
									>
										${item.buttonText}
										<i class="fa-solid fa-chevron-right ml-1"></i>
									</a>
								` : ''}
								${item.document ? `
									<a
										href="${item.document}"
										target="_blank"
										rel="noopener noreferrer"
										class="inline-flex items-center text-gray-600 hover:text-gray-800 font-medium"
									>
										<i class="fa-solid fa-file-pdf mr-1"></i>
										Download PDF
									</a>
								` : ''}
							</div>
						</div>
					</article>
				`).join('');
			}

			loadingEl?.classList.add('hidden');
			gridEl?.classList.remove('hidden');
		} catch (error) {
			console.error('Failed to load news:', error);
			loadingEl?.classList.add('hidden');
			errorEl?.classList.remove('hidden');
		}
	}

	loadNews();
</script>
